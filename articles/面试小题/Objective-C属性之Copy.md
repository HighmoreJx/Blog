# copy
è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯çœ‹[iOS ä¸­çš„ Copying](https://joeshang.github.io/),ç„¶åå°ç»“ä¸€ä¸‹.

## è‡ªé—®è‡ªç­”

ğŸ§ ä»€ä¹ˆæ˜¯æ‹·è´?  
ğŸ˜ƒ : ä¸€æ¨¡ä¸€æ ·çš„æ¥ä¸€ä»½å‘—.   

ğŸ§ æ‹·è´çš„åœºæ™¯æ˜¯å•¥?  
ğŸ˜ƒ: æˆ‘ä»¬å›åˆ°ç†Ÿæ‚‰çš„æŠ„ä½œä¸š. æ¯å½“æš‘å‡è¦å®Œçš„æ—¶å€™, æˆ‘ä»¬æ€»ä¼šåœ¨ä¸´è¿‘å‰çš„æœ€åä¸€å¤©ç–¯ç‹‚æŠ„å¤§ä½¬çš„ä½œä¸š. è¿™ä¸ªå°±æ˜¯æ‹·è´æœ€å¥½çš„ä¾‹å­äº†.    
ğŸ§  ä¸€æ¨¡ä¸€æ ·ä¼šä¸ä¼šè¢«è€å¸ˆæŠ“?
ğŸ¤«: å’³å’³. å¯¹, æŠ“ç´§æ”¹å‡ é“é¢˜çš„ç­”æ¡ˆ. ä½ çš„æ”¹åŠ¨ä¼šä¸ä¼šå½±å“åˆ°å¤§ä½¬çš„é‚£ä»½? æ˜¾ç„¶æ˜¯ä¸ä¼šçš„.    
ğŸ˜¶ æˆ‘å¤´é“, æˆ‘ä¸€ä¸ªå­—éƒ½ä¸æƒ³æ”¹.  
ğŸ˜ˆ: ä½ æ˜¯åœ¨æŒ‘æˆ˜è€å¸ˆçš„æ™ºå•†å—? åå­—éƒ½æŠ„ä¸€æ ·çš„.ä½ è¿™æ‹·è´æ¯«æ— æ„ä¹‰, ç»“å±€éƒ½æ˜¯GG.  

ğŸ‘¨â€ğŸ« : æ‹·è´çš„ä¸»è¦ç›®çš„æ˜¯ç”¨äºæ‹·è´ä¸€ä»½æ–°çš„æ•°æ®è¿›è¡Œä¿®æ”¹, è€Œä¸ä¼šå½±å“åˆ°åŸæ¥çš„æ•°æ®.å¦‚æœä¸ä¿®æ”¹, æ‹·è´å°±æ²¡æœ‰å¿…è¦. 

## Objective-C ä¸­çš„æ‹·è´
ä¸¾ä¸ªğŸŒ°:
```
NSInteger b = 3;
NSInteger a = b;
a = 5;
```
NSIntegeræ˜¯å€¼ç±»å‹, ä¸Šé¢å°±æ˜¯æœ€ç®€å•çš„ä¸€æ¬¡æ‹·è´.

ä¸¾ä¸ªğŸ:
```
@interface Person : NSObject
@property (nonatomic, assign) int age;
@property (nonatomic, strong) NSMuatableString *name;
@end

Person *person1 = [[Person alloc] init];
Person *person2 = person1;
```
ğŸ¤¥ è¿™æ˜¯OCå¯¹è±¡çš„æ‹·è´.

```
person1.age = 10;
person2. age = 20;
```

æœ€åå‘ç° ~ person1 å’Œ person2 å±…ç„¶åŒå²äº†â€¦  
ğŸ§ æˆ‘ä»¬è¯´è¿‡, æ‹·è´çš„æ„å›¾åœ¨äºäº§ç”Ÿä¸€ä»½ç›¸åŒçš„æ•°æ®, ç„¶åå¯ä»¥ä»»æ„ä¿®æ”¹ä¸”ä¸å½±å“åŸå§‹ç‰ˆæœ¬. å¾ˆæ˜æ˜¾ä¸Šé¢çš„ä¾‹å­æ ¹æœ¬ä¸ç¬¦åˆæ¡ä»¶. æ‰€ä»¥æ ¹æœ¬ä¸æ˜¯æ‹·è´.  

ä¸¥è‚ƒä¸€ç‚¹çœ‹ä¸‹å®˜ç½‘:  [Object copying](https://developer.apple.com/library/archive/documentation/General/Conceptual/DevPedia-CocoaCore/ObjectCopying.html)  
æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸€å¥è¯: 
>  If you receive an object from elsewhere in an application but do not copy it, you share the object with its owner (and perhaps others), who might change the encapsulated contents  

ç®€å•æ¥è¯´, ä¸Šé¢çš„ä¾‹å­åªæ˜¯å¤šäº†ä¸€ä¸ªæŒæœ‰å…³ç³», æ ¹æœ¬ä¸æ˜¯æ‹·è´! åªæœ‰ä¸¤ä¸ªå€¼ç±»å‹å¯¹è±¡çš„èµ‹å€¼æ‰å®Œå…¨ç¬¦åˆæˆ‘ä»¬å¯¹æ‹·è´çš„è®¤çŸ¥.

ğŸ˜³ å¾ˆæ‡µé€¼, é‚£OCå¯¹è±¡è¦æ€ä¹ˆæ‹·è´? 
ğŸ§ æ˜¯æ—¶å€™çœ‹çœ‹[è‹¹æœå®˜æ–¹æ–‡æ¡£]([NSCopying - Foundation | Apple Developer Documentation](https://developer.apple.com/documentation/foundation/nscopying?language=objc))äº†.  

ğŸ˜€ ç®€å•æ¥è¯´, å°±æ˜¯è¦å®ç°NSCoyingåè®®.  
```
#import "Person.h"

@interface Person()<NSCopying>
@end

@implementation Person
- (id)init {
    if (self = [super init]) {
        _name = [[NSMutableString alloc] initWithString:@"mike"];
    }
    return self;
}

- (id)copyWithZone:(NSZone *)zone {
    Person *object = [[[self class] allocWithZone:zone] init];
    object.name = _name;
    object.age = _age;
    return object;
}
@end

Person *person1 = [[Person alloc] init];
Person *person2 = [person1 copy];
person1.age = 10;
person2.age = 20;
```
è¿™ä¸ªæ—¶å€™é€šè¿‡è¾“å‡º, æˆ‘ä»¬å¯ä»¥å‘ç°ä¸¤ä¸ªäººçš„å¹´çºªå·²ç»ä¸åŒäº†.

ğŸ˜ƒ è¿™å®Œå…¨ç¬¦åˆæˆ‘ä»¬å¯¹æ‹·è´çš„å®šä¹‰. ç¨‹åºä»å †ä¸­å¼€è¾Ÿå‡ºäº†å®Œå…¨ç‹¬ç«‹çš„ç©ºé—´é‡æ–°æ„é€ äº†person2å¯¹è±¡. æˆ‘ä»¬å¯¹person2çš„æ“ä½œå®Œå…¨ç‹¬ç«‹ä¸person1.

ğŸ˜ˆä¸€åˆ‡çœŸçš„è¿™ä¹ˆç®€å•å—?
```
[person2.name insertString:@"funny " atIndex:0];
```
çµå¼‚çš„äº‹æƒ…å‘ç”Ÿäº†, person1ä¹Ÿè¢«æ”¹äº†.è¿™å°±å®Œå…¨ä¸ç¬¦åˆæ‹·è´çš„æ„å›¾äº†.  

ğŸ˜ é‚£ä¹ˆé—®é¢˜å‡ºåœ¨å“ªé‡Œäº†å‘¢?  
`object.name = _name;`  
ä¸Šé¢è¯´è¿‡è¿™ä¸ªæ ¹æœ¬ä¸æ˜¯æ‹·è´, è¿™æ˜¯å¤šäº†ä¸€ä¸ªæŒæœ‰å…³ç³»è€Œå·²(å¤šäº†ä¸€ä¸ªå¼•ç”¨).ç›¸å½“äºä¸€ä¸ªç›’å­æœ‰ä¸¤æŠŠé’¥åŒ™, ç›’å­é‡Œé¢è£…çš„ä¸œè¥¿å˜äº†, é‚£éšä¾¿ä½ ç”¨å“ªæŠŠé’¥åŒ™æ‰“å¼€ç›’å­, æœ€åé‡Œé¢çš„ä¸œè¥¿è‚¯å®šæ˜¯æœ€æ–°æ”¾å…¥çš„.  

ğŸ‘¨â€ğŸ« æŒ‡é’ˆå¯¹è±¡è™½ç„¶è¢«æ‹·è´äº†, ä½†ä¸¤è€…è¿˜æ˜¯æŒ‡å‘åŒä¸€å—å†…å­˜ç©ºé—´.  

### æ·±æ‹·è´ä¸æµ…æ‹·è´

![object copy](https://joeshang.github.io/images/blog/ios-object-copy.png)

ä¸Šé¢æ˜¯è‹¹æœå®˜æ–¹æ–‡æ¡£çš„ä¸€å¹…å›¾, å›¾ä¸­å·¦ä¾§å°±å¾ˆæ¸…æ™°çš„å±•ç¤ºäº†æˆ‘ä»¬ä¸Šé¢æ‰€æè¿°çš„person.nameçš„åœºæ™¯.   
åŒæ—¶æˆ‘ä»¬æ³¨æ„åˆ°, å›¾ä¸­å³ä¾§è¿˜æœ‰ä¸€å‰¯å¯¹æ¯”å›¾.ä¸¤å¹…å›¾åˆ†åˆ«å¯¹åº”äº†ç¨‹åºå¼€å‘çš„æµ…å¤åˆ¶ä¸æ·±å¤åˆ¶.  

ğŸ˜’ é‚£æˆ‘ä»¬personå¦‚ä½•åšåˆ°æ·±å¤åˆ¶å‘¢?
```
- (id)copyWithZone:(NSZone *)zone {
    Person *object = [[[self class] allocWithZone:zone] init];
    object.name = [[NSMutableString alloc] initWithString:object.name];
    object.age = _age;
    return object;
}
```
ğŸ˜€ è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å†æ‰“å°çœ‹çœ‹, person2å¯¹nameçš„æ”¹å˜ä¸æ¯«ä¸ä¼šå½±å“åˆ°person1äº†.  

ğŸ‘¨â€ğŸ«    
æµ…å¤åˆ¶: æŒ‡é’ˆæ‹·è´, ä»…ä»…æ‹·è´æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆ  
æ·±å¤åˆ¶: å†…å®¹æ‹·è´, ä¼šæ‹·è´å¯¹è±¡æœ¬èº«  

âš ï¸ æ·±æµ…å¤åˆ¶å½¢å®¹çš„æ˜¯æˆå‘˜å˜é‡æœ‰å¯¹è±¡æŒ‡é’ˆçš„æƒ…å†µ!
ä¸‹é¢æ‘˜ä¸€ä¸‹ç½‘ä¸Šæ–‡ç« çš„ä¾‹å­:
```
 NSString *string1 = @"helloworld";
 NSString *string2 = [string1 copy]; // æµ…æ‹·è´
 NSString *string3 = [string1 mutableCopy]; // æ·±æ‹·è´
 NSMutableString *string4 = [string1 copy]; // æµ…æ‹·è´
 NSMutableString *string5 = [string1 mutableCopy]; // æ·±æ‹·è´
```
è¿™äº›ç»“è®ºå°±æ˜¯å¼ºè¡Œå¸¦å…¥æ·±æµ…æ‹·è´çš„æ¦‚å¿µ. è¿™æ ¹æœ¬æ²¡æœ‰åƒPersoné‚£æ ·æœ‰æŒ‡é’ˆæˆå‘˜å˜é‡, å“ªæœ‰ä»€ä¹ˆæ·±ä¸æ·±æµ…ä¸æµ…, å°±åªæ˜¯åˆ†æƒ…å†µå‘ç”Ÿäº†æ‹·è´æˆ–è€…æ²¡æœ‰æ‹·è´è€Œå·².  

ğŸ˜’ 
1. NSStringæœ¬æ¥å°±ä¸å¯å˜, æ‹·è´ä¸€ä¸ªä¸å¯å˜çš„string2æœ‰ä»€ä¹ˆæ„ä¹‰, æ‰€ä»¥string2æŒ‡é’ˆåªéœ€è¦æŒæœ‰ä¸€ä¸‹stirng1çš„å†…å®¹å°±å¯ä»¥äº†, æ ¹æœ¬æ²¡æœ‰æ‹·è´çš„å¿…è¦
2. å‰©ä¸‹çš„å‡ ç§éƒ½ç‰µæ¶‰åˆ°æ”¹å˜ä¸èƒ½ç›¸äº’å½±å“, æ‰€ä»¥éœ€è¦æ‹·è´ä¸€ä¸‹. 

ç»¼ä¸Š, å“ªé‡Œéœ€è¦ä»€ä¹ˆæ·±æµ…? åªæ˜¯ä¸€ä¸ªéœ€ä¸éœ€è¦æ‹·è´è€Œå·²â€¦.  

ğŸ‘¨â€ğŸ«   
1. ä¸å¯å˜å¯¹è±¡ copyï¼šå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå†å¤åˆ¶å‡ºä¸€ä»½ä¸å¯å˜å¯¹è±¡æ²¡æœ‰æ„ä¹‰ï¼Œå› æ­¤æ ¹æœ¬æ²¡æœ‰å‘ç”Ÿä»»ä½•æ‹·è´ï¼Œå¯¹è±¡åªæœ‰ä¸€ä»½ã€‚  
2. ä¸å¯å˜å¯¹è±¡ mutableCopyï¼šå¯å˜å¯¹è±¡çš„èƒ½å¤Ÿä¿®æ”¹ï¼ŒåŸæ¥çš„ä¸å¯å˜å¯¹è±¡ä¸æ”¯æŒï¼Œå› æ­¤éœ€è¦å¤åˆ¶å‡ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ‹·è´ã€‚  
3. å¯å˜å¯¹è±¡ copyï¼šä¸å¯å˜å¯¹è±¡ä¸èƒ½ä¿®æ”¹ï¼ŒåŸæ¥çš„å¯å˜å¯¹è±¡ä¸æ”¯æŒï¼Œå› æ­¤éœ€è¦å¤åˆ¶å‡ºæ–°å¯¹è±¡ï¼Œæ‹·è´ã€‚  
4. å¯å˜å¯¹è±¡ mutableCopyï¼šå¯å˜å¯¹è±¡çš„ä¿®æ”¹ä¸åº”è¯¥å½±å“åˆ°åŸæ¥çš„å¯å˜å¯¹è±¡ï¼Œå› æ­¤éœ€è¦å¤åˆ¶å‡ºæ–°å¯¹è±¡ï¼Œæ‹·è´ã€‚  
5. å¦‚æœæ‹·è´çš„å¯¹è±¡çš„æˆå‘˜å˜é‡æœ‰æŒ‡é’ˆæŒ‡å‘å¦å¤–çš„å†…å­˜ç©ºé—´, æ‰å­˜åœ¨æ·±,æµ…çš„æ¦‚å¿µ.

## é›†åˆçš„æ‹·è´
![é›†åˆæ‹·è´](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Art/CopyingCollections_2x.png)

é›†åˆå¯¹è±¡å³NSArray ä¸ NSMutableArray ç­‰, å…¶å®å°±æ‹·è´è€Œè¨€, ä»–ä»¬å’ŒPersonçš„ä¾‹å­å¹¶æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§åŒºåˆ«.   

ä¸¾ä¸ªğŸŒ°
```
NSMutableString *str1 = [[NSMutableString alloc] initWithString:@"1"];
NSArray *arr1 = [NSArray arrayWithObjects:str1, nil];
NSArray *arr2 = [arr1 copy];
NSMutableArray *arr3 = [arr1 mutableCopy];

NSLog(@"%p %p %p", arr1, arr2, arr3);
```
è¾“å‡º:
```
0x100514b80 0x100514b80 0x100514d10
```
ä¾§é¢éªŒè¯ä¸Šé¢è¯´çš„æ˜¯å¦å‘ç”Ÿæ‹·è´çš„æ€»ç»“, æ²¡æ¯›ç—…, å®Œå…¨é€‚ç”¨.  
```
[str1 insertString:@"0" atIndex:0];
NSLog(@"%@ %@ %@", arr1[0], arr2[0], arr3[0]);
``` 
è¾“å‡º:
```
01 01 01
```

ğŸ˜’ ä¸€æ”¹æ€ä¹ˆå…¨æ”¹äº†?  
ğŸ˜‚ è¿™ä¸ªå°±å’Œpersonçš„nameç±»ä¼¼çš„çŠ¶å†µ, æ•°ç»„çš„æŒ‡é’ˆå¯¹è±¡çš„ç¡®è¢«æ‹·è´äº†, ä½†æ˜¯å¤§å®¶éƒ½æŒ‡å‘åŒä¸€ä¸ªå†…å­˜ç©ºé—´, æ¢å¥è¯è¯´å°±æ˜¯å¤šäº†å‡ ä¸ªæŒæœ‰å…³ç³»è€Œå·².è¿™ä¹Ÿå°±æ˜¯æµ…å¤åˆ¶.    
ğŸ˜€ æ‰€ä»¥æˆ‘ä»¬å¹³æ—¶ç”¨çš„ç³»ç»Ÿçš„é›†åˆå¯¹è±¡è°ƒç”¨copyæˆ–è€…mutablecopy, è¦ä¹ˆå°±æ²¡æ‹·è´, è¦ä¹ˆå°±æµ…æ‹·è´.  

ğŸ˜’é‚£æ€ä¹ˆæ·±å¤åˆ¶?  
```
NSArray *arr4 = [[NSArray alloc] initWithArray:arr1 copyItems:YES];
[str1 insertString:@"0" atIndex:0];
NSLog(@"%p %p %p %p", arr1, arr2, arr3, arr4);
NSLog(@"%@ %@ %@ %@", arr1[0], arr2[0], arr3[0], arr4[0]);
```
è¾“å‡º:  
```
0x100514b80 0x100514b80 0x100514d10 0x100516bb0
01 01 01 1
```
ğŸ˜€ å®Œç¾, è¾¾åˆ°äº†æˆ‘ä»¬æœ€åˆæƒ³è¦çš„æ‹·è´æ•ˆæœ, å‰¯æœ¬å’Œæºæœ¬äº’ä¸å½±å“.  

âš ï¸  è¿™ä¸ªæ·±å¤åˆ¶ä¹Ÿä¸æ˜¯ä½ æƒ³çš„å®Œç¾çŠ¶æ€, ä¸‹é¢å¼•ç”¨å¤§ç¥çš„ç»“è®º, æˆ‘æ„Ÿè§‰å¾ˆæ¸…æ™°æ˜“æ‡‚äº†, ä¹Ÿå°±ä¸çŒ®ä¸‘æ€»ç»“äº†.(å‡ºè‡ªæ–‡ç« æœ€å¼€å¤´çš„åšå®¢)  

> å¯¹äºé›†åˆç±»å‹çš„å¯¹è±¡ï¼Œå°† initWithArray:copyItems: ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®æˆ YES æ—¶ï¼Œä¼šå¯¹é›†åˆå†…æ¯ä¸€ä¸ªå…ƒç´ å‘é€ copyWithZone: æ¶ˆæ¯ï¼Œå…ƒç´ è¿›è¡Œå¤åˆ¶ï¼Œä½†æ˜¯å¯¹äºå…ƒç´ ä¸­æŒ‡é’ˆç±»å‹çš„æˆå‘˜å˜é‡ï¼Œä¾ç„¶æ˜¯æµ…æ‹·è´ï¼Œå› æ­¤è¿™ç§æ‹·è´è¢«ç§°ä¸ºå•å±‚æ·±æ‹·è´ï¼ˆone-level-deep copyï¼‰ã€‚

> å¦‚æœæƒ³è¿›è¡Œå®Œå…¨çš„æ·±æ‹·è´ï¼Œå¯ä»¥å…ˆé€šè¿‡ NSKeyedArchiver å°†å¯¹è±¡å½’æ¡£ï¼Œå†é€šè¿‡ NSKeyedUnarchiver å°†å¯¹è±¡è§£å½’æ¡£ã€‚ç”±äºåœ¨å½’æ¡£æ—¶ï¼Œå¯¹è±¡ä¸­æ¯ä¸ªæˆå‘˜å˜é‡éƒ½ä¼šæ”¶åˆ° encodeWithCoder: æ¶ˆæ¯ï¼Œç›¸å½“äºå°†å¯¹è±¡æ‰€æœ‰çš„æ•°æ®å‡åºåˆ—åŒ–ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼ˆå¯ä»¥çœ‹æˆæ¢äº†ç§æ•°æ®æ ¼å¼çš„æ‹·è´ï¼‰ï¼Œå†é€šè¿‡ initWithCoder: è§£å½’æ¡£æ—¶ï¼Œå°±å°†æ‹·è´è¿‡çš„æ•°æ®ç»è¿‡è½¬æ¢åè¯»å–å‡ºæ¥ï¼Œæ·±æ‹·è´ã€‚




